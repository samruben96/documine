# Epic 5 Retrospective: Document Q&A with Trust Transparency (MVP)

**Date:** 2025-12-01
**Facilitator:** Bob (Scrum Master)
**Participants:** Sam (Project Lead)
**Scope:** Stories 5.1-5.6 (MVP Chat Functionality)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Epic | 5: Document Q&A with Trust Transparency |
| Stories Reviewed | 6 (5.1-5.6) |
| Stories Completed | 6/6 (100%) |
| Tests Added | 181 (507 → 688 total) |
| Production Incidents | 4 bugs found and fixed |
| Optimization Stories Drafted | 4 (5.7-5.10) |

**Key Deliverables:**
- Split-view layout (document + chat side-by-side)
- Chat input with Enter/Shift+Enter handling
- AI responses with confidence badges (High/Needs Review/Not Found)
- Source citations with page numbers
- PDF document viewer with react-pdf (zoom, navigation)
- Conversation history persistence
- Mobile responsive tabbed interface

---

## What Went Well

### Team Collaboration
- **BMAD agents working together effectively** - Clean handoffs between analyst, architect, SM, and dev
- Story-to-story learnings continued from Epic 4
- Party mode reviews enhanced story quality

### Infrastructure Complete
- **Chat UI fully functional** - Split view, input, message display all working
- **Document viewer working** - PDF rendering, zoom, page navigation
- **Conversation persistence** - Messages saved to database, history loads on return
- **Test coverage strong** - 181 new tests added across 6 stories

### Trust Element UI
- Confidence badges display correctly (green/amber/gray)
- Source citation links render with page numbers
- Click-to-highlight navigation implemented

---

## What Needs Improvement

### Critical Issues Discovered

| Issue | Severity | Notes |
|-------|----------|-------|
| **Streaming not working** | HIGH | Responses should appear word-by-word but don't |
| **RAG always returns "Not Found"** | HIGH | Low similarity scores, retrieval quality issue |
| **AI too rigid/robotic** | HIGH | Doesn't handle greetings, thanks, general chat naturally |

### Process Issues

| Issue | Notes |
|-------|-------|
| Story 5.6 commit bundled with bug fixes | Should have dedicated commit per story |
| Multiple integration bugs found late | Document viewer status, client/server boundary, validation errors, vector search 404 |

### AI Personality Gap
- User says "hello" → AI responds "I couldn't find information about that"
- No natural conversation handling (greetings, thanks, general questions)
- Needs to feel more **human** - friendly, conversational, helpful

---

## Bugs Fixed During Epic

| Bug | Root Cause | Fix |
|-----|-----------|-----|
| Document viewer infinite loading | Status check used 'completed' instead of 'ready' | Changed to `status !== 'ready'` |
| Vector search 404 | pgvector `extensions` schema not in search_path | Added `SET search_path = public, extensions` |
| Chat validation error | `conversationId: null` sent but Zod expected string/undefined | Only include conversationId when truthy |
| Chat 500 error | `calculateConfidence()` called from server but defined in client component | Created shared module `src/lib/chat/confidence.ts` |

---

## Previous Retro Follow-Through

**From Epic 4 Retrospective (2025-11-30):**

| Action Item | Status | Notes |
|-------------|--------|-------|
| PI-1: Verify story file matches sprint-status | ⚠️ Partial | Story 5.6 marked done but commit bundled |
| PI-2: Fill in Dev Agent Record before review | ✅ Applied | Story records complete |
| TD-1: Add unit tests for queue management | ⏳ Deferred | Not addressed |
| DOC-1: Customize Supabase email templates | ⏳ Carried | Still pending |

---

## Action Items

### Critical Fixes (Before Story 5.8)

| ID | Item | Owner | Priority |
|----|------|-------|----------|
| FIX-1 | Debug streaming - investigate why responses don't appear word-by-word | Dev | HIGH |
| FIX-2 | Improve AI personality - update system prompt to handle greetings, thanks, general chat naturally | Dev | HIGH |

### Process Improvements

| ID | Item | Owner | Priority |
|----|------|-------|----------|
| PI-1 | Create dedicated commits per story (don't bundle with bug fixes) | All | MEDIUM |

### Technical Debt (Addressed by Optimization Stories)

| ID | Item | Addressed By | Priority |
|----|------|--------------|----------|
| TD-1 | RAG retrieval quality - "Not Found" issue | Story 5.8 | HIGH |
| TD-2 | Chunking optimization | Story 5.9 | MEDIUM |
| TD-3 | Model evaluation | Story 5.10 | LOW |

### Carried Forward

| ID | Item | Origin | Priority |
|----|------|--------|----------|
| DOC-1 | Customize Supabase email templates | Epic 3 | LOW |

---

## Next Steps

### Recommended Order

1. **FIX-1 & FIX-2** - Fix streaming and AI personality before optimization work
2. **Story 5.8** - Retrieval Quality Optimization (Cohere reranking, hybrid search)
3. **Story 5.9** - Chunking Optimization (recursive splitting, table preservation)
4. **Story 5.10** - Model Evaluation (GPT-4o vs alternatives)
5. **Story 5.7** - Responsive Chat (can parallel or defer)

### Stories Ready for Development

| Story | Title | Status | Dependencies |
|-------|-------|--------|--------------|
| 5.7 | Responsive Chat Experience | Drafted | None |
| 5.8 | Retrieval Quality Optimization | Drafted | FIX-1, FIX-2 recommended first |
| 5.9 | Chunking Optimization | Drafted | Story 5.8 |
| 5.10 | Model Evaluation | Drafted | Story 5.9 |

---

## Key Takeaways

1. **MVP infrastructure is complete** - UI, persistence, document viewer all working
2. **RAG quality is the critical gap** - Stories 5.8-5.10 designed to address this
3. **AI needs personality** - System prompt should allow natural conversation, not just document queries
4. **Streaming needs debugging** - Core feature not working as intended
5. **Collaboration was strong** - Team handoffs and workflows effective

---

## Retrospective Metadata

- **Generated:** 2025-12-01
- **Workflow:** BMAD Retrospective v1.0
- **Epic Duration:** 2025-11-30 to 2025-12-01
- **Next Retrospective:** After Epic 5 optimization stories (5.7-5.10) or Epic 6
