<story-context id="Q3-3-field-validation-formatting" v="1.0">
  <metadata>
    <epicId>Q3</epicId>
    <storyId>3</storyId>
    <title>Field Validation & Formatting</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epics/epic-Q3/stories/Q3-3-field-validation-formatting/story.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>insurance agent</asA>
    <iWant>form fields to validate my input and auto-format data consistently</iWant>
    <soThat>I can catch errors before submission and have properly formatted data ready for carrier portals</soThat>
    <tasks>
      <task id="1" name="Create validation utility functions" acs="1-10">
        <subtask>1.1 Create/update src/lib/quoting/validation.ts with VIN validator function</subtask>
        <subtask>1.2 Add VIN character exclusion regex (no I, O, Q)</subtask>
        <subtask>1.3 Add ZIP code validation (5 digits or ZIP+4)</subtask>
        <subtask>1.4 Add email validation regex</subtask>
        <subtask>1.5 Add phone validation (exactly 10 digits after stripping non-digits)</subtask>
        <subtask>1.6 Export typed validation result interface</subtask>
      </task>
      <task id="2" name="Enhance VIN input component" acs="1-5">
        <subtask>2.1 Update vin-input.tsx to auto-uppercase on input</subtask>
        <subtask>2.2 Add validation indicator (checkmark for valid, error for invalid)</subtask>
        <subtask>2.3 Display VIN decode success message</subtask>
        <subtask>2.4 Display VIN decode warning on failure</subtask>
        <subtask>2.5 Ensure manual entry fields remain editable on decode failure</subtask>
      </task>
      <task id="3" name="Create inline error display component" acs="11-13">
        <subtask>3.1 Create src/components/quoting/field-error.tsx</subtask>
        <subtask>3.2 Style with red text, positioned below field</subtask>
        <subtask>3.3 Add red border styling for fields with errors</subtask>
        <subtask>3.4 Implement error clearing on valid input</subtask>
      </task>
      <task id="4" name="Integrate validation into form tabs" acs="6-10,17-22">
        <subtask>4.1 Update client-info-tab.tsx with email, phone, ZIP validation on blur</subtask>
        <subtask>4.2 Update property-tab.tsx with ZIP validation and currency formatting</subtask>
        <subtask>4.3 Update auto-tab.tsx with VIN validation integration</subtask>
        <subtask>4.4 Update drivers-tab.tsx with phone validation</subtask>
        <subtask>4.5 Wire date picker components to display MM/DD/YYYY and store ISO format</subtask>
      </task>
      <task id="5" name="Implement currency formatting" acs="14-16">
        <subtask>5.1 Update src/lib/quoting/formatters.ts with formatCurrencyDisplay function</subtask>
        <subtask>5.2 Add parseCurrencyInput to strip formatting for editing</subtask>
        <subtask>5.3 Create currency input wrapper component or use existing pattern</subtask>
        <subtask>5.4 Handle decimal preservation in currency values</subtask>
      </task>
      <task id="6" name="Implement ZIP auto-formatting" acs="8">
        <subtask>6.1 Create formatZipCode function that auto-inserts hyphen for ZIP+4</subtask>
        <subtask>6.2 Integrate into address input fields</subtask>
      </task>
      <task id="7" name="Update tab completion logic" acs="23-24">
        <subtask>7.1 Update tab completion calculation to exclude tabs with validation errors</subtask>
        <subtask>7.2 Verify navigation is NOT blocked by validation errors</subtask>
        <subtask>7.3 Ensure auto-save continues to work even with validation errors</subtask>
      </task>
      <task id="8" name="Write unit tests" acs="all">
        <subtask>8.1 Create __tests__/lib/quoting/validation.test.ts</subtask>
        <subtask>8.2 Test VIN validation (valid/invalid cases, character exclusions)</subtask>
        <subtask>8.3 Test ZIP validation (5-digit, ZIP+4, invalid formats)</subtask>
        <subtask>8.4 Test email validation (valid/invalid patterns)</subtask>
        <subtask>8.5 Test phone validation (10 digits, stripping non-digits)</subtask>
        <subtask>8.6 Test currency formatting (with/without decimals, thousands)</subtask>
      </task>
      <task id="9" name="Write component tests" acs="1-5,11-13">
        <subtask>9.1 Create __tests__/components/quoting/vin-input.test.tsx</subtask>
        <subtask>9.2 Test uppercase conversion, validation indicator, decode messages</subtask>
        <subtask>9.3 Create __tests__/components/quoting/field-error.test.tsx</subtask>
        <subtask>9.4 Test error display, red border styling, error clearing</subtask>
      </task>
      <task id="10" name="Write E2E tests" acs="1-2,6-7,9-10,14,17">
        <subtask>10.1 Create __tests__/e2e/quoting/field-validation.spec.ts</subtask>
        <subtask>10.2 Test VIN validation flow</subtask>
        <subtask>10.3 Test ZIP validation flow</subtask>
        <subtask>10.4 Test email validation flow</subtask>
        <subtask>10.5 Test currency formatting on blur</subtask>
        <subtask>10.6 Test phone formatting as user types</subtask>
      </task>
      <task id="11" name="Verify build and run full test suite" acs="all">
        <subtask>11.1 Run npm run build - verify no type errors</subtask>
        <subtask>11.2 Run npm run test - verify all tests pass</subtask>
        <subtask>11.3 Run npm run lint - verify no lint errors</subtask>
        <subtask>11.4 Manual testing of validation across all form tabs</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-Q3.3-1" fr="FR16">Given a user enters a VIN, when the VIN is exactly 17 alphanumeric characters excluding I, O, Q, then a green checkmark indicator appears next to the field</criterion>
    <criterion id="AC-Q3.3-2" fr="FR16">Given a user enters an invalid VIN (wrong length or contains I, O, Q), when the field loses focus, then an inline error "Invalid VIN format" appears below the field</criterion>
    <criterion id="AC-Q3.3-3" fr="FR16">Given a user is typing a VIN, when the input contains lowercase letters, then they are automatically converted to uppercase</criterion>
    <criterion id="AC-Q3.3-4" fr="FR16">Given a user enters a valid VIN, when the NHTSA decode succeeds, then Year/Make/Model are auto-populated and a success message appears briefly</criterion>
    <criterion id="AC-Q3.3-5" fr="FR16">Given a user enters a valid VIN, when the NHTSA decode fails, then a warning appears and manual entry fields remain editable</criterion>
    <criterion id="AC-Q3.3-6" fr="FR17">Given a user enters a ZIP code, when the format is 5 digits (XXXXX) or ZIP+4 (XXXXX-XXXX), then no error is shown</criterion>
    <criterion id="AC-Q3.3-7" fr="FR17">Given a user enters an invalid ZIP code format, when the field loses focus, then an inline error "Invalid ZIP code" appears below the field</criterion>
    <criterion id="AC-Q3.3-8" fr="FR17">Given a user is typing ZIP+4, when they enter the 5th digit, then a hyphen is automatically inserted</criterion>
    <criterion id="AC-Q3.3-9" fr="FR7">Given a user enters an email address, when the format matches standard email pattern, then no error is shown</criterion>
    <criterion id="AC-Q3.3-10" fr="FR7">Given a user enters an invalid email format, when the field loses focus, then an inline error "Invalid email address" appears</criterion>
    <criterion id="AC-Q3.3-11" fr="FR16,FR17">Given any field has a validation error, when the error is displayed, then the error text appears inline directly below the field</criterion>
    <criterion id="AC-Q3.3-12" fr="FR16,FR17">Given any field has a validation error, when the error is displayed, then the field has a red border highlight</criterion>
    <criterion id="AC-Q3.3-13" fr="FR16,FR17">Given a field with a validation error, when the user corrects the input, then the error message and red border are removed</criterion>
    <criterion id="AC-Q3.3-14" fr="FR9">Given a user enters a currency value, when the field loses focus, then the value displays with $ prefix and thousands separators</criterion>
    <criterion id="AC-Q3.3-15" fr="FR9">Given a user clicks into a currency field, when the field gains focus, then the formatted display is converted back to digits-only</criterion>
    <criterion id="AC-Q3.3-16" fr="FR9">Given a user enters a currency value with decimal places, when the field loses focus, then decimals are preserved</criterion>
    <criterion id="AC-Q3.3-17" fr="FR18">Given a user enters a phone number, when 10 digits are entered, then the display auto-formats to (XXX) XXX-XXXX</criterion>
    <criterion id="AC-Q3.3-18" fr="FR18">Given a user enters a phone number with non-digit characters, then only digits are retained</criterion>
    <criterion id="AC-Q3.3-19" fr="FR18">Given a user enters fewer than 10 digits for phone, when the field loses focus, then an inline error "Phone must be 10 digits" appears</criterion>
    <criterion id="AC-Q3.3-20" fr="FR18">Given date fields (DOB), when displayed, then dates show in MM/DD/YYYY format</criterion>
    <criterion id="AC-Q3.3-21" fr="FR18">Given date fields, when stored, then dates are saved in ISO YYYY-MM-DD format</criterion>
    <criterion id="AC-Q3.3-22" fr="FR18">Given a user selects a date via date picker, then the field immediately displays the formatted date</criterion>
    <criterion id="AC-Q3.3-23" fr="FR7-14">Given a tab contains required fields with validation errors, then the tab does NOT show the completion checkmark</criterion>
    <criterion id="AC-Q3.3-24" fr="FR7-14">Given a user attempts to navigate away from a tab with validation errors, then navigation is NOT blocked (errors are warnings only)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/epics/epic-Q3/tech-spec.md" title="Epic Q3 Technical Specification" section="Story Q3.3: Field Validation &amp; Formatting">
        AC-3.3.1 through AC-3.3.9: VIN validation, ZIP validation, email validation, inline errors, currency formatting
      </doc>
      <doc path="docs/features/quoting/prd.md" title="Quoting Helper PRD" section="Client Data Capture (FR7-18)">
        FR7: Email validation; FR9: Currency formatting; FR16: VIN validation; FR17: ZIP validation; FR18: Phone/date formatting
      </doc>
      <doc path="docs/features/quoting/architecture.md" title="Quoting Architecture" section="Implementation Patterns">
        Auto-save pattern, validation strategy, error display patterns, format on blur approach
      </doc>
      <doc path="docs/sprint-artifacts/epics/epic-Q3/stories/Q3-2-auto-save-implementation/story.md" title="Previous Story Q3.2" section="Dev Agent Record">
        Learnings: formatters exist, validation schemas exist, onBlur handlers already wired, type safety patterns
      </doc>
    </docs>
    <code>
      <file path="src/lib/quoting/validation.ts" kind="validation" symbol="addressSchema,vehicleSchema,driverSchema" reason="Existing Zod schemas to extend with validation functions; already has ZIP regex, VIN regex">
        <lines>31-254</lines>
      </file>
      <file path="src/lib/quoting/formatters.ts" kind="utility" symbol="formatPhoneNumber,formatCurrency,formatVIN,isValidVINFormat" reason="Existing formatters to enhance; already has phone, currency, VIN formatting; add currency display/parse for focus/blur">
        <lines>1-233</lines>
      </file>
      <file path="src/components/quoting/vin-input.tsx" kind="component" symbol="VINInput" reason="Existing VIN input component; add validation indicator (checkmark/error), enhance decode messaging">
        <lines>1-157</lines>
      </file>
      <file path="src/hooks/quoting/use-auto-save.ts" kind="hook" symbol="useAutoSave" reason="Auto-save must continue working with validation errors; validation should NOT block saves">
        <lines>1-392</lines>
      </file>
      <file path="src/components/quoting/tabs/client-info-tab.tsx" kind="component" symbol="ClientInfoTab" reason="Add email, phone, ZIP validation on blur; integrate inline error display">
        <lines>all</lines>
      </file>
      <file path="src/components/quoting/tabs/property-tab.tsx" kind="component" symbol="PropertyTab" reason="Add ZIP validation and currency formatting for dwelling/deductible fields">
        <lines>all</lines>
      </file>
      <file path="src/components/quoting/tabs/auto-tab.tsx" kind="component" symbol="AutoTab" reason="Integrate VIN validation with validation indicator; show decode success/failure messages">
        <lines>all</lines>
      </file>
      <file path="src/components/quoting/tabs/drivers-tab.tsx" kind="component" symbol="DriversTab" reason="Add phone validation if driver contact fields exist">
        <lines>all</lines>
      </file>
      <file path="src/components/ui/input.tsx" kind="component" symbol="Input" reason="Base input component; already has aria-invalid:border-destructive styling for error state">
        <lines>1-41</lines>
      </file>
    </code>
    <dependencies>
      <node>
        <package name="zod" version="^4.1.13" purpose="Schema validation - use for field-level validation with custom error messages"/>
        <package name="react-hook-form" version="^7.68.0" purpose="Form state management - integrates with Zod via @hookform/resolvers"/>
        <package name="@hookform/resolvers" version="^5.2.2" purpose="Zod resolver for react-hook-form integration"/>
        <package name="use-debounce" version="^10.0.6" purpose="Debounced callbacks for auto-save - already in use"/>
        <package name="lucide-react" version="^0.554.0" purpose="Icons for validation indicators (CheckCircle2, AlertCircle)"/>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Validation timing: On blur, NOT on every keystroke - prevents intrusive errors while typing</constraint>
    <constraint type="pattern">Error display: Inline below field (NOT toast) - immediate visual context for the error</constraint>
    <constraint type="pattern">VIN uppercase: Convert on input (not blur) - prevents user confusion with lowercase VINs</constraint>
    <constraint type="pattern">Currency edit mode: Strip formatting on focus - allows natural number entry without fighting formatter</constraint>
    <constraint type="pattern">Navigation: NOT blocked by validation errors - errors are warnings, auto-save still works</constraint>
    <constraint type="pattern">Auto-save: Must continue working even with validation errors - per Q3.2 implementation</constraint>
    <constraint type="architecture">Client-side validation only - server validates on save via Zod schemas in API route</constraint>
    <constraint type="ux">Tab completion checkmark: Do NOT show if required fields have validation errors</constraint>
    <constraint type="testing">All validation functions need unit tests; E2E tests for user flows</constraint>
  </constraints>

  <interfaces>
    <interface name="ValidationResult" kind="type" path="src/lib/quoting/validation.ts">
      <signature>interface ValidationResult { valid: boolean; error?: string }</signature>
    </interface>
    <interface name="isValidVin" kind="function" path="src/lib/quoting/formatters.ts">
      <signature>function isValidVINFormat(vin: string): boolean</signature>
      <note>Already exists - returns true if VIN is 17 chars, alphanumeric excluding I, O, Q</note>
    </interface>
    <interface name="formatCurrency" kind="function" path="src/lib/quoting/formatters.ts">
      <signature>function formatCurrency(value: number | string | undefined | null): string</signature>
      <note>Already exists - formats as currency with $ prefix and thousands separators</note>
    </interface>
    <interface name="formatPhoneNumber" kind="function" path="src/lib/quoting/formatters.ts">
      <signature>function formatPhoneNumber(value: string): string</signature>
      <note>Already exists - formats as (XXX) XXX-XXXX</note>
    </interface>
    <interface name="addressSchema.zipCode" kind="zod-field" path="src/lib/quoting/validation.ts">
      <signature>zipCode: z.string().regex(/^\d{5}(-\d{4})?$/, 'Invalid ZIP code format')</signature>
      <note>Already exists - validates 5-digit or ZIP+4 format</note>
    </interface>
    <interface name="vehicleSchema.vin" kind="zod-field" path="src/lib/quoting/validation.ts">
      <signature>vin: z.string().refine(val => /^[A-HJ-NPR-Z0-9]{17}$/.test(val), 'VIN must be 17 characters')</signature>
      <note>Already exists - validates VIN format excluding I, O, Q</note>
    </interface>
    <interface name="Input component error state" kind="css" path="src/components/ui/input.tsx">
      <signature>aria-invalid:ring-destructive/20 aria-invalid:border-destructive</signature>
      <note>Already has error styling - set aria-invalid="true" on input to show red border</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for unit/integration tests (npm run test), Playwright for E2E (__tests__/e2e/). Follow existing patterns in __tests__/hooks/quoting/use-auto-save.test.ts for hook testing. Use @testing-library/react for component tests. Mock external APIs (NHTSA) in tests.
    </standards>
    <locations>
      <location>__tests__/lib/quoting/validation.test.ts (NEW - validation functions)</location>
      <location>__tests__/lib/quoting/formatters.test.ts (EXTEND - currency display/parse)</location>
      <location>__tests__/components/quoting/vin-input.test.tsx (NEW - validation indicators)</location>
      <location>__tests__/components/quoting/field-error.test.tsx (NEW - inline error component)</location>
      <location>__tests__/e2e/quoting/field-validation.spec.ts (NEW - E2E validation flows)</location>
    </locations>
    <ideas>
      <idea ac="1-3">VIN validation: test valid 17-char VINs, invalid length, contains I/O/Q, uppercase conversion</idea>
      <idea ac="4-5">VIN decode integration: mock NHTSA success/failure, verify message display</idea>
      <idea ac="6-8">ZIP validation: test 5-digit, ZIP+4, invalid formats, auto-hyphen insertion</idea>
      <idea ac="9-10">Email validation: test valid patterns, invalid patterns, inline error display</idea>
      <idea ac="11-13">Inline error display: test red border appears, error message below field, clears on valid input</idea>
      <idea ac="14-16">Currency formatting: test $ prefix, thousands separators, decimal preservation, focus strips formatting</idea>
      <idea ac="17-19">Phone formatting: test (XXX) XXX-XXXX format, digit extraction, 10-digit validation</idea>
      <idea ac="20-22">Date formatting: test MM/DD/YYYY display, ISO storage, date picker integration</idea>
      <idea ac="23-24">Tab completion: test checkmark hidden with errors, navigation not blocked</idea>
    </ideas>
  </tests>
</story-context>
