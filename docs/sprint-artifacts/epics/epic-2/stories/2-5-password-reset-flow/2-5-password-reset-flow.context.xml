<story-context id="bmm/story-context" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>5</storyId>
    <title>Password Reset Flow</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-password-reset-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user who forgot my password</asA>
    <iWant>to reset it via email verification</iWant>
    <soThat>I can regain access to my account</soThat>
    <tasks>
      <task id="1" status="pending">Install Resend Package - npm install resend, add RESEND_API_KEY and NEXT_PUBLIC_APP_URL to env</task>
      <task id="2" status="pending">Create Resend Email Client - src/lib/email/resend.ts with sendPasswordResetEmail function</task>
      <task id="3" status="pending">Create Password Reset Request Page - src/app/(auth)/reset-password/page.tsx with email form, 60s cooldown</task>
      <task id="4" status="pending">Create Reset Password Server Action - src/app/(auth)/reset-password/actions.ts with requestPasswordReset()</task>
      <task id="5" status="pending">Create Password Update Page - src/app/(auth)/reset-password/update/page.tsx with password form, strength indicator</task>
      <task id="6" status="pending">Create Password Update Server Action - updatePassword() in actions.ts</task>
      <task id="7" status="pending">Update Login Page for Success Message - check for ?reset=success query param</task>
      <task id="8" status="pending">Configure Supabase Email Templates - verify redirect URL</task>
      <task id="9" status="pending">Add Unit and Integration Tests - actions and email client tests</task>
      <task id="10" status="pending">Manual Testing and Verification - full flow test</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.5.1">Reset request page (/reset-password) accepts email and shows generic success message regardless of email existence. Button disabled 60 seconds after submit.</criterion>
    <criterion id="AC-2.5.2">Reset email sent via Resend with secure link valid for 1 hour. Subject: "Reset your docuMINE password"</criterion>
    <criterion id="AC-2.5.3">Reset link redirects to password update page (/reset-password/update?code=xxx&amp;type=recovery)</criterion>
    <criterion id="AC-2.5.4">New password must meet strength requirements: 8+ chars, 1 uppercase, 1 number, 1 special character. Show strength indicator.</criterion>
    <criterion id="AC-2.5.5">Expired link shows error with "Request new link" option</criterion>
    <criterion id="AC-2.5.6">Successful reset redirects to login with success message toast</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Story 2.5: Password Reset Flow">
        Contains server action patterns for requestPasswordReset() and updatePassword(), email template structure, and password reset flow diagram. References AC-2.5.1 through AC-2.5.6.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="Authentication Flow">
        Defines auth patterns: httpOnly cookies, session management, security headers. Password hashing via Supabase Auth bcrypt.
      </doc>
      <doc path="docs/epics.md" title="Epics" section="Story 2.5: Password Reset Flow">
        User story definition and acceptance criteria for password reset via email verification.
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design" section="Color Theme">
        Trustworthy Slate theme colors, form styling patterns, loading states, toast notifications.
      </doc>
    </docs>

    <code>
      <artifact path="documine/src/lib/validations/auth.ts" kind="validation" symbol="signupSchema.password" lines="19-24" reason="Contains reusable password validation: min 8 chars, 1 uppercase, 1 number, 1 special char. Extract to separate passwordSchema for reuse."/>
      <artifact path="documine/src/lib/supabase/server.ts" kind="service" symbol="createClient" lines="9-33" reason="Server-side Supabase client for auth operations. Use for resetPasswordForEmail() and updateUser() calls."/>
      <artifact path="documine/src/app/(auth)/login/actions.ts" kind="action" symbol="login, logout" lines="21-61" reason="Server action pattern to follow. Shows error handling, validation, redirect pattern."/>
      <artifact path="documine/src/app/(auth)/login/page.tsx" kind="page" symbol="LoginPage" reason="Needs modification to display success message from ?reset=success query param."/>
      <artifact path="documine/src/components/auth/password-strength.tsx" kind="component" symbol="PasswordStrength" reason="Existing password strength indicator component - reuse in update password form."/>
      <artifact path="documine/src/middleware.ts" kind="middleware" symbol="middleware" reason="Already handles /reset-password as public route (line 6: PUBLIC_ROUTES). No changes needed."/>
      <artifact path="documine/src/app/(auth)/layout.tsx" kind="layout" symbol="AuthLayout" reason="Auth pages layout with Trustworthy Slate styling. New reset-password pages inherit this."/>
      <artifact path="documine/src/app/(auth)/signup/page.tsx" kind="page" symbol="SignupPage" reason="Reference for form patterns with react-hook-form, Zod validation, loading states."/>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/ssr" version="^0.7.0" reason="Server-side auth with cookies"/>
        <package name="@supabase/supabase-js" version="^2.84.0" reason="Supabase client for resetPasswordForEmail, updateUser"/>
        <package name="zod" version="^4.1.13" reason="Form validation schemas"/>
        <package name="react-hook-form" version="^7.66.1" reason="Form state management"/>
        <package name="@hookform/resolvers" version="^5.2.2" reason="Zod integration with react-hook-form"/>
        <package name="sonner" version="^2.0.7" reason="Toast notifications for success/error messages"/>
        <package name="resend" version="latest" reason="NEW - Email delivery for password reset"/>
      </node>
      <env>
        <var name="NEXT_PUBLIC_SUPABASE_URL" status="existing"/>
        <var name="NEXT_PUBLIC_SUPABASE_ANON_KEY" status="existing"/>
        <var name="RESEND_API_KEY" status="new" desc="Resend API key for transactional emails"/>
        <var name="NEXT_PUBLIC_APP_URL" status="new" desc="App URL for password reset links (e.g., http://localhost:3000)"/>
      </env>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="supabase.auth.resetPasswordForEmail" kind="supabase-method">
      <signature>resetPasswordForEmail(email: string, options?: { redirectTo?: string }): Promise&lt;AuthResponse&gt;</signature>
      <path>@supabase/supabase-js</path>
      <usage>Sends password reset email. Set redirectTo to /reset-password/update for callback handling.</usage>
    </interface>
    <interface name="supabase.auth.updateUser" kind="supabase-method">
      <signature>updateUser(attributes: { password?: string }): Promise&lt;UserResponse&gt;</signature>
      <path>@supabase/supabase-js</path>
      <usage>Updates user password after recovery token validation. Requires active recovery session.</usage>
    </interface>
    <interface name="createClient" kind="function">
      <signature>async function createClient(): Promise&lt;SupabaseClient&lt;Database&gt;&gt;</signature>
      <path>documine/src/lib/supabase/server.ts</path>
      <usage>Creates authenticated Supabase client for server actions.</usage>
    </interface>
    <interface name="sendPasswordResetEmail" kind="function">
      <signature>async function sendPasswordResetEmail(email: string, resetLink: string): Promise&lt;{ success: boolean; error?: string }&gt;</signature>
      <path>documine/src/lib/email/resend.ts (TO CREATE)</path>
      <usage>Sends password reset email via Resend API with professional template.</usage>
    </interface>
    <interface name="passwordSchema" kind="zod-schema">
      <signature>z.string().min(8).regex(/[A-Z]/).regex(/[0-9]/).regex(/[^A-Za-z0-9]/)</signature>
      <path>documine/src/lib/validations/auth.ts (EXTRACT FROM signupSchema)</path>
      <usage>Reusable password validation schema for reset flow.</usage>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="security">Generic success message on reset request - never reveal if email exists (prevents enumeration attacks)</constraint>
    <constraint type="security">Reset links valid for 1 hour only - enforced by Supabase Auth</constraint>
    <constraint type="security">Password strength requirements enforced server-side and client-side</constraint>
    <constraint type="ux">60-second button cooldown after reset request to prevent spam</constraint>
    <constraint type="ux">Use Suspense boundary for useSearchParams() in Next.js 16</constraint>
    <constraint type="pattern">Server actions pattern - all auth operations use 'use server' actions, not API routes</constraint>
    <constraint type="pattern">Generic error messages - "Invalid email or password" pattern for security</constraint>
    <constraint type="style">Trustworthy Slate color theme per UX spec</constraint>
    <constraint type="testing">All new server actions must have corresponding tests in __tests__/ directory</constraint>
  </constraints>

  <tests>
    <standards>
      Vitest with React Testing Library. Unit tests for validation schemas and utility functions. Integration tests for server actions with mocked Supabase client. Tests located in __tests__/ directory mirroring src/ structure. Use happy-dom for DOM testing environment.
    </standards>
    <locations>
      <location>documine/__tests__/app/auth/reset-password/actions.test.ts (TO CREATE)</location>
      <location>documine/__tests__/lib/email/resend.test.ts (TO CREATE)</location>
      <location>documine/__tests__/lib/validations/auth.test.ts (EXISTING - add password schema tests)</location>
    </locations>
    <ideas>
      <idea ac="AC-2.5.1">Test requestPasswordReset returns success regardless of email existence</idea>
      <idea ac="AC-2.5.1">Test form validation rejects invalid email format</idea>
      <idea ac="AC-2.5.2">Test sendPasswordResetEmail calls Resend with correct template</idea>
      <idea ac="AC-2.5.4">Test updatePassword rejects weak passwords (short, no uppercase, no number, no special)</idea>
      <idea ac="AC-2.5.4">Test updatePassword calls supabase.auth.updateUser on valid input</idea>
      <idea ac="AC-2.5.5">Test updatePassword handles expired session error gracefully</idea>
      <idea ac="AC-2.5.6">Test successful password update redirects to /login?reset=success</idea>
      <idea ac="AC-2.5.6">Test login page displays success message when reset=success param present</idea>
    </ideas>
  </tests>
</story-context>
