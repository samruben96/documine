# Story 23.7: PDF/Excel Export

Status: done

## Story

As an **insurance agent**,
I want **to download my generated report as a PDF or Excel file**,
so that **I can share findings with colleagues, archive reports, or use the data in other applications**.

## Acceptance Criteria

1. **AC-23.7.1**: PDF export includes report title, summary, insights, and embedded charts
2. **AC-23.7.2**: Excel export includes original data rows plus a summary sheet with insights
3. **AC-23.7.3**: Export buttons (PDF/Excel) are visible and accessible in the report view header
4. **AC-23.7.4**: Downloads start immediately on click (no email required, client-side generation)
5. **AC-23.7.5**: Export filenames follow pattern: `docuMINE-report-YYYY-MM-DD.{pdf|xlsx}`
6. **AC-23.7.6**: PDF includes page numbers and "Generated by docuMINE" footer
7. **AC-23.7.7**: Excel summary sheet includes all insights with type and severity
8. **AC-23.7.8**: Export buttons disabled during report generation (loading state)

## Tasks / Subtasks

- [x] **Task 1: Create PDF Export Service** (AC: 1, 4, 5, 6)
  - [x] Create `src/lib/reporting/pdf-export.tsx`
  - [x] Use `@react-pdf/renderer` (already installed from Story 7.6)
  - [x] Use `file-saver` (already installed from Story 7.6)
  - [x] Define `ReportPDFDocument` component with styled sections
  - [x] Include header with title, date, and branding
  - [x] Render summary text section
  - [x] Render insights as styled list with icons (finding/trend/anomaly/recommendation)
  - [x] Render charts as static images (convert Recharts SVG to image)
  - [x] Add page numbers and footer
  - [x] Export `downloadReportPdf(report: GeneratedReport): Promise<void>`

- [x] **Task 2: Create Excel Export Service** (AC: 2, 4, 5, 7)
  - [x] Create `src/lib/reporting/excel-export.ts`
  - [x] Use `xlsx` library (already installed from Story 23.1)
  - [x] Create "Data" sheet with all rows from `report.dataTable`
  - [x] Create "Summary" sheet with report title, summary, and generatedAt
  - [x] Create "Insights" sheet with columns: Type, Title, Description, Severity
  - [x] Apply column widths and header formatting
  - [x] Export `downloadReportExcel(report: GeneratedReport): Promise<void>`

- [x] **Task 3: Add Export Buttons to ReportView** (AC: 3, 8)
  - [x] Update `src/components/reporting/report-view.tsx`
  - [x] Add "Export PDF" button with Download icon
  - [x] Add "Export Excel" button with FileSpreadsheet icon
  - [x] Position buttons in report header (right-aligned)
  - [x] Disable buttons during report generation (when `isGenerating` prop is true)
  - [x] Add loading state during export (show spinner on button)

- [x] **Task 4: Chart to Image Conversion for PDF** (AC: 1)
  - [x] Research approach: canvas-based SVG rendering or html2canvas
  - [x] Create `captureChartsBySelector()` in `src/lib/reporting/chart-capture.ts`
  - [x] Handle Recharts SVG → PNG conversion via html2canvas
  - [x] Embed base64 images in PDF document

- [x] **Task 5: Unit Tests** (AC: 1-8)
  - [x] Create `__tests__/lib/reporting/pdf-export.test.tsx` (21 tests)
  - [x] Test PDF document renders with all sections
  - [x] Test insights render with correct icons/styling
  - [x] Test page numbers and footer present
  - [x] Create `__tests__/lib/reporting/excel-export.test.ts` (32 tests)
  - [x] Test Excel workbook has Data, Summary, and Insights sheets
  - [x] Test data sheet contains all rows from report
  - [x] Test insights sheet has correct columns
  - [x] Create `__tests__/components/reporting/report-view-export.test.tsx` (23 tests)
  - [x] Test export buttons render
  - [x] Test buttons disabled during generation
  - [x] Test button click triggers download

- [x] **Task 6: E2E Tests** (AC: 3, 4)
  - [x] Update `__tests__/e2e/report-generation.spec.ts` (10 new tests)
  - [x] Test PDF download button visible after report generation
  - [x] Test Excel download button visible after report generation
  - [x] Test clicking PDF button initiates download
  - [x] Test clicking Excel button initiates download

## Dev Notes

### Learnings from Previous Story

**From Story 23.6 (Status: done)**

- **ReportView Component**: Located at `src/components/reporting/report-view.tsx` - add export buttons to header
- **ReportDataTable Integration**: Data table already renders with `report.dataTable` props - use same data for Excel
- **Test Patterns**: 46 unit tests in `report-data-table.test.tsx` following describe/it pattern
- **Accessibility Pattern**: Used `role="img"` and `aria-label` - apply to export buttons
- **ChartConfig Structure**: `{ type, title, data, xKey, yKey }` - already defined in types

**Key Integration Points**:
- `ReportView` receives `GeneratedReport` with `{ title, summary, insights, charts, dataTable, generatedAt, promptUsed }`
- Charts rendered via `ReportChart` component - need to capture as images for PDF
- Data table available as `report.dataTable.columns` and `report.dataTable.rows`

[Source: docs/sprint-artifacts/epics/epic-23/stories/23-6-interactive-data-table/story.md#Dev-Agent-Record]

### Existing Export Pattern in Codebase

**Reference Implementation**: `src/lib/compare/pdf-export.tsx` (Story 7.6)
- Uses `@react-pdf/renderer` with `Document`, `Page`, `Text`, `View`, `StyleSheet`
- Uses `file-saver` with `saveAs(blob, filename)`
- Pattern: React component → `pdf(doc).toBlob()` → `saveAs(blob, filename)`
- Filename format: `docuMINE-comparison-YYYY-MM-DD.pdf`
- Includes header with branding, table data, and summary sections

**Reusable Utilities**:
- `formatDateForFilename()` from `src/lib/compare/export.ts`

### Technical Constraints

1. **Chart Image Generation**:
   - Recharts renders SVG in browser
   - Options: (a) Use `html2canvas` to capture chart div, (b) Use `canvg` to render SVG to canvas, (c) Pre-render charts server-side
   - **Recommended**: Use `html2canvas` for simplicity - capture each chart container

2. **File Size Limits**:
   - PDF with embedded chart images could be large
   - Consider image compression or limiting chart count

3. **Browser Compatibility**:
   - `file-saver` handles cross-browser download differences
   - Canvas APIs well-supported in modern browsers

### Project Structure Notes

**New Files:**
- `src/lib/reporting/pdf-export.tsx` - PDF generation service
- `src/lib/reporting/excel-export.ts` - Excel generation service
- `__tests__/lib/reporting/pdf-export.test.tsx`
- `__tests__/lib/reporting/excel-export.test.ts`
- `__tests__/components/reporting/report-view-export.test.tsx`

**Modified Files:**
- `src/components/reporting/report-view.tsx` - Add export buttons
- `__tests__/e2e/report-generation.spec.ts` - Add export E2E tests

### TypeScript Types Available

From `src/types/reporting.ts`:
- `GeneratedReport` - Full report structure with title, summary, insights, charts, dataTable
- `ChartConfig` - Chart configuration with type, data, xKey, yKey
- `ReportInsight` - Insight with type, title, description, severity

### Design Decisions

1. **Client-Side Generation**: PDF and Excel generated entirely in browser (no API calls). This provides:
   - Immediate download experience (AC-23.7.4)
   - No server load for export operations
   - Works offline after report is generated

2. **Excel Sheet Structure**: Three sheets for clarity:
   - "Data" - Raw data rows (primary sheet)
   - "Summary" - Title, summary text, generated timestamp
   - "Insights" - Structured table of findings

3. **PDF Layout**: Single-column layout with sections:
   - Header (title, date, branding)
   - Summary paragraph
   - Insights (bulleted list with icons)
   - Charts (one per section, scaled to fit)
   - Footer (page numbers, "Generated by docuMINE")

4. **Chart Capture Strategy**: Use refs to access chart DOM elements, then `html2canvas` to convert to base64 PNG.

### Dependencies

**Already Installed (verify in package.json):**
- `@react-pdf/renderer` - PDF generation
- `file-saver` - Cross-browser file download
- `xlsx` - Excel file generation
- `html2canvas` - May need to install for chart capture

### References

- [Source: docs/sprint-artifacts/epics/epic-23/tech-spec.md#Export-Story-23.7]
- [Source: src/lib/compare/pdf-export.tsx] - Existing PDF export pattern
- [Source: src/lib/compare/export.ts] - Filename formatting utility
- [Source: src/components/reporting/report-view.tsx] - Report view component to modify
- [Source: src/types/reporting.ts#GeneratedReport] - Report data structure

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/23-7-pdf-excel-export.context.xml

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- All 8 acceptance criteria implemented and tested
- PDF export with branding, title, summary, insights (with icons), and chart images
- Excel export with 3 sheets: Data, Summary, Insights
- 76 new unit tests (21 PDF, 32 Excel, 23 component)
- 10 new E2E tests for export functionality
- Build passes, all tests pass (100/100 for export-related tests)

### File List

**New Files:**
- `src/lib/reporting/pdf-export.tsx` - PDF generation with @react-pdf/renderer
- `src/lib/reporting/excel-export.ts` - Excel generation with xlsx library
- `src/lib/reporting/chart-capture.ts` - Chart to image conversion with html2canvas
- `__tests__/lib/reporting/pdf-export.test.tsx` - 21 unit tests
- `__tests__/lib/reporting/excel-export.test.ts` - 32 unit tests
- `__tests__/components/reporting/report-view-export.test.tsx` - 23 component tests

**Modified Files:**
- `src/components/reporting/report-view.tsx` - Added export buttons with loading states
- `__tests__/components/reporting/report-view.test.tsx` - Updated tests for new prop interface
- `__tests__/e2e/report-generation.spec.ts` - Added 10 E2E tests for export

**Dependencies Added:**
- `html2canvas` - For chart image capture

## Change Log

| Date | Version | Description |
|------|---------|-------------|
| 2025-12-10 | 1.0 | Initial story draft |
| 2025-12-10 | 2.0 | Implementation complete - all tasks done |
