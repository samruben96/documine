<story-context id="20-1-audit-log-infrastructure" v="1.0">
  <metadata>
    <epicId>20</epicId>
    <storyId>1</storyId>
    <title>Audit Log Infrastructure</title>
    <status>drafted</status>
    <generatedAt>2025-12-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epics/epic-20/stories/20-1-audit-log-infrastructure/story-20.1-audit-log-infrastructure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>compliance administrator</asA>
    <iWant>immutable audit logs with enforced append-only policies</iWant>
    <soThat>our agency maintains tamper-proof records for regulatory compliance and E&O protection</soThat>
    <tasks>
      <task id="1" ac="20.1.3">
        <title>Verify Existing Schema</title>
        <subtasks>
          <subtask>Confirm `ai_buddy_audit_logs` table exists with correct columns</subtask>
          <subtask>Verify column types: id (uuid), agency_id (uuid FK), user_id (uuid FK), conversation_id (uuid FK nullable), action (text), metadata (jsonb), logged_at (timestamptz)</subtask>
          <subtask>Check existing RLS policies on the table</subtask>
          <subtask>Document current state for comparison</subtask>
        </subtasks>
      </task>
      <task id="2" ac="20.1.2">
        <title>Create Immutability Trigger</title>
        <subtasks>
          <subtask>Create `prevent_audit_modification()` function in migration</subtask>
          <subtask>Function raises exception: "Audit logs are immutable - modifications not allowed"</subtask>
          <subtask>Create trigger `audit_logs_immutable` on `ai_buddy_audit_logs`</subtask>
          <subtask>Trigger fires BEFORE UPDATE OR DELETE</subtask>
          <subtask>Test trigger blocks both UPDATE and DELETE operations</subtask>
        </subtasks>
      </task>
      <task id="3" ac="20.1.1">
        <title>Update RLS Policies</title>
        <subtasks>
          <subtask>Verify INSERT-only policy exists for audit logs</subtask>
          <subtask>Ensure INSERT policy checks agency_id matches user's agency</subtask>
          <subtask>Verify no UPDATE/DELETE policies exist (or if they do, they block all operations)</subtask>
          <subtask>Ensure admin SELECT policy requires `view_audit_logs` permission</subtask>
          <subtask>Test INSERT succeeds for valid agency users</subtask>
        </subtasks>
      </task>
      <task id="4" ac="20.1.4">
        <title>Create Admin Query Indexes</title>
        <subtasks>
          <subtask>Create index: `idx_audit_logs_agency_date` on (agency_id, logged_at DESC)</subtask>
          <subtask>Create index: `idx_audit_logs_action` on (action) for filtering by action type</subtask>
          <subtask>Create partial index: `idx_audit_logs_metadata_guardrail` on (metadata->>'guardrailType') WHERE metadata->>'guardrailType' IS NOT NULL</subtask>
          <subtask>Test query performance with EXPLAIN ANALYZE</subtask>
        </subtasks>
      </task>
      <task id="5" ac="20.1.2,20.1.4,20.1.6">
        <title>Write Migration</title>
        <subtasks>
          <subtask>Create migration file: `supabase/migrations/YYYYMMDDHHMMSS_audit_log_immutability.sql`</subtask>
          <subtask>Include all trigger and index creation</subtask>
          <subtask>Write DOWN migration that preserves data (only removes trigger/indexes, not data)</subtask>
          <subtask>Test migration applies cleanly to fresh database</subtask>
          <subtask>Test DOWN migration preserves audit data</subtask>
        </subtasks>
      </task>
      <task id="6" ac="20.1.5">
        <title>Document Retention Policy</title>
        <subtasks>
          <subtask>Add retention policy section to tech spec or architecture doc</subtask>
          <subtask>Specify 7-year minimum retention requirement</subtask>
          <subtask>Reference insurance industry compliance standards (NAIC model bulletin)</subtask>
          <subtask>Document future archival strategy considerations</subtask>
          <subtask>Add comment in migration file referencing retention policy</subtask>
        </subtasks>
      </task>
      <task id="7" ac="20.1.1,20.1.2">
        <title>Integration Tests</title>
        <subtasks>
          <subtask>Create `__tests__/lib/ai-buddy/audit-log-immutability.test.ts`</subtask>
          <subtask>Test: INSERT succeeds for valid agency user</subtask>
          <subtask>Test: UPDATE fails with immutability error</subtask>
          <subtask>Test: DELETE fails with immutability error</subtask>
          <subtask>Test: RLS blocks cross-agency INSERT</subtask>
          <subtask>Test: Admin can SELECT with view_audit_logs permission</subtask>
          <subtask>Test: Non-admin cannot SELECT audit logs</subtask>
        </subtasks>
      </task>
      <task id="8" ac="20.1.3">
        <title>Verify Existing Audit Logger</title>
        <subtasks>
          <subtask>Review `src/lib/ai-buddy/audit-logger.ts` for correct field population</subtask>
          <subtask>Ensure all required metadata fields are captured</subtask>
          <subtask>Verify audit logger handles insert failures gracefully</subtask>
          <subtask>Add TypeScript types for metadata if not present</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-20.1.1">
      <description>INSERT-Only RLS Policy</description>
      <given>the `ai_buddy_audit_logs` table exists</given>
      <when>any user attempts to INSERT a valid audit entry</when>
      <then>the insert succeeds if the agency_id matches the user's agency</then>
    </criterion>
    <criterion id="AC-20.1.2">
      <description>Database Trigger Prevents Modifications</description>
      <given>an audit log entry exists</given>
      <when>any user (including service role) attempts to UPDATE or DELETE the entry</when>
      <then>the operation fails with an explicit error message "Audit logs are immutable - modifications not allowed"</then>
    </criterion>
    <criterion id="AC-20.1.3">
      <description>Audit Log Entry Schema</description>
      <given>a new audit log entry is created</given>
      <then>it includes all required fields: id (uuid), agency_id, user_id, conversation_id (nullable), action (text), metadata (JSONB), logged_at (timestamptz)</then>
    </criterion>
    <criterion id="AC-20.1.4">
      <description>Admin Query Index</description>
      <given>an admin queries audit logs for their agency</given>
      <when>filtering by agency_id and date range</when>
      <then>query performance is &lt; 2s using the (agency_id, logged_at DESC) index</then>
    </criterion>
    <criterion id="AC-20.1.5">
      <description>Retention Policy Documentation</description>
      <given>the audit log infrastructure is deployed</given>
      <then>documentation clearly states the 7-year minimum retention requirement for insurance industry compliance</then>
    </criterion>
    <criterion id="AC-20.1.6">
      <description>Rollback Script Preserves Data</description>
      <given>the migration is applied</given>
      <when>the rollback script is executed</when>
      <then>existing audit log data is preserved (no data loss)</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-20.md</path>
        <title>Epic 20 Tech Spec: AI Buddy Admin &amp; Audit</title>
        <section>Story 20.1 Acceptance Criteria, Security</section>
        <snippet>Details INSERT-only RLS policy, immutability trigger SQL, retention policy (7-year), and index definitions for audit log infrastructure.</snippet>
      </doc>
      <doc>
        <path>docs/features/ai-buddy/architecture.md</path>
        <title>AI Buddy Architecture</title>
        <section>Data Architecture, RLS Policies</section>
        <snippet>Defines ai_buddy_audit_logs table schema, append-only RLS policies, and ADR-AIB-003 decision for Supabase PostgreSQL storage.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/data-architecture.md</path>
        <title>docuMINE Data Architecture</title>
        <section>Core Tables, RLS Policies</section>
        <snippet>Core database patterns, RLS policy structure, and multi-tenant agency isolation approach used across docuMINE.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/security-architecture.md</path>
        <title>Security Architecture</title>
        <section>Authentication Flow, Data Protection</section>
        <snippet>JWT authentication with RLS using auth.uid(), TLS 1.3 transit encryption, AES-256 at-rest encryption.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql</path>
        <kind>migration</kind>
        <symbol>ai_buddy_audit_logs table, RLS policies</symbol>
        <lines>150-180, 356-376</lines>
        <reason>Existing audit_logs table definition, indexes (idx_audit_logs_agency_date, idx_audit_logs_user, idx_audit_logs_action), and RLS policies (INSERT via service role, SELECT by admins with view_audit_logs permission)</reason>
      </file>
      <file>
        <path>src/lib/ai-buddy/audit-logger.ts</path>
        <kind>service</kind>
        <symbol>logAuditEvent, logGuardrailEvent, queryAuditLogs</symbol>
        <lines>1-264</lines>
        <reason>Existing audit log helper functions for INSERT operations. Story needs to verify correct field population and graceful error handling.</reason>
      </file>
      <file>
        <path>src/types/ai-buddy.ts</path>
        <kind>types</kind>
        <symbol>AuditLogEntry, AuditAction</symbol>
        <lines>341-359, 18-34 (audit-logger.ts)</lines>
        <reason>TypeScript interfaces for audit log entries and action types. Verify types match schema.</reason>
      </file>
      <file>
        <path>src/app/api/ai-buddy/admin/guardrails/logs/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET /api/ai-buddy/admin/guardrails/logs</symbol>
        <reason>Existing guardrail enforcement logs endpoint. Pattern reference for admin audit log queries.</reason>
      </file>
      <file>
        <path>src/lib/supabase/server.ts</path>
        <kind>service</kind>
        <symbol>createClient, createServiceClient</symbol>
        <reason>Supabase client creation patterns. Audit logger uses regular client for RLS-compliant INSERT.</reason>
      </file>
      <file>
        <path>__tests__/lib/ai-buddy/guardrails.test.ts</path>
        <kind>test</kind>
        <symbol>guardrails test patterns</symbol>
        <reason>Reference for Vitest test patterns used in AI Buddy. Follow similar structure for immutability tests.</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.84.0</version>
        <usage>Database queries, RLS, migrations</usage>
      </node>
      <node>
        <package>vitest</package>
        <version>^4.0.14</version>
        <usage>Test framework for integration tests</usage>
      </node>
      <node>
        <package>@testing-library/react</package>
        <version>^16.3.0</version>
        <usage>React testing utilities</usage>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="database">
      <rule>Audit logs are APPEND-ONLY. No UPDATE or DELETE policies allowed at RLS level.</rule>
      <source>docs/features/ai-buddy/architecture.md#ADR-AIB-003</source>
    </constraint>
    <constraint type="database">
      <rule>Immutability trigger must fire BEFORE UPDATE OR DELETE to block even service role modifications.</rule>
      <source>docs/sprint-artifacts/tech-spec-epic-20.md#Security</source>
    </constraint>
    <constraint type="compliance">
      <rule>7-year minimum retention for insurance industry compliance (NAIC model bulletin).</rule>
      <source>docs/features/ai-buddy/architecture.md</source>
    </constraint>
    <constraint type="performance">
      <rule>Audit log queries must complete in &lt; 2s with (agency_id, logged_at DESC) index.</rule>
      <source>docs/sprint-artifacts/tech-spec-epic-20.md#Performance</source>
    </constraint>
    <constraint type="pattern">
      <rule>RLS uses auth.uid() for user identification. Admin access requires view_audit_logs permission check.</rule>
      <source>docs/architecture/security-architecture.md</source>
    </constraint>
    <constraint type="rollback">
      <rule>DOWN migration must preserve existing audit data - only remove trigger/indexes, not table or data.</rule>
      <source>Story AC-20.1.6</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ai_buddy_audit_logs table</name>
      <kind>database-table</kind>
      <signature>
CREATE TABLE ai_buddy_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agency_id UUID NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  conversation_id UUID REFERENCES ai_buddy_conversations(id) ON DELETE SET NULL,
  action VARCHAR(50) NOT NULL,
  metadata JSONB,
  logged_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
      </signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql</path>
    </interface>
    <interface>
      <name>logAuditEvent</name>
      <kind>function</kind>
      <signature>
async function logAuditEvent(input: AuditLogInput): Promise&lt;void&gt;
interface AuditLogInput {
  agencyId: string;
  userId: string;
  conversationId?: string;
  action: AuditAction;
  metadata?: Record&lt;string, unknown&gt;;
}
      </signature>
      <path>src/lib/ai-buddy/audit-logger.ts</path>
    </interface>
    <interface>
      <name>INSERT RLS Policy</name>
      <kind>database-policy</kind>
      <signature>
CREATE POLICY "Service can insert audit logs" ON ai_buddy_audit_logs
  FOR INSERT WITH CHECK (auth.role() = 'service_role');
      </signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql</path>
    </interface>
    <interface>
      <name>SELECT RLS Policy</name>
      <kind>database-policy</kind>
      <signature>
CREATE POLICY "Admins can view agency audit logs" ON ai_buddy_audit_logs
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM ai_buddy_permissions
      WHERE user_id = auth.uid()
      AND permission = 'view_audit_logs'
    )
    AND agency_id = get_user_agency_id()
  );
      </signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql</path>
    </interface>
    <interface>
      <name>prevent_audit_modification (NEW)</name>
      <kind>database-trigger</kind>
      <signature>
CREATE OR REPLACE FUNCTION prevent_audit_modification()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'Audit logs are immutable - modifications not allowed';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_logs_immutable
  BEFORE UPDATE OR DELETE ON ai_buddy_audit_logs
  FOR EACH ROW EXECUTE FUNCTION prevent_audit_modification();
      </signature>
      <path>NEW - supabase/migrations/YYYYMMDDHHMMSS_audit_log_immutability.sql</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing follows Vitest + Testing Library patterns established in Epic 14-19. Database integration tests use Supabase test client with service role for setup and user role for assertions. Unit tests mock Supabase client. Test files located in __tests__/ mirroring src/ structure. E2E tests use Playwright.
    </standards>
    <locations>
      <location>__tests__/lib/ai-buddy/</location>
      <location>__tests__/app/api/ai-buddy/</location>
    </locations>
    <ideas>
      <testIdea ac="AC-20.1.1">
        <name>test_insert_succeeds_for_valid_agency_user</name>
        <description>Verify INSERT via logAuditEvent succeeds when agency_id matches user's agency</description>
      </testIdea>
      <testIdea ac="AC-20.1.1">
        <name>test_rls_blocks_cross_agency_insert</name>
        <description>Verify INSERT fails when agency_id does not match authenticated user's agency</description>
      </testIdea>
      <testIdea ac="AC-20.1.2">
        <name>test_update_fails_with_immutability_error</name>
        <description>Verify UPDATE on ai_buddy_audit_logs raises "Audit logs are immutable" exception</description>
      </testIdea>
      <testIdea ac="AC-20.1.2">
        <name>test_delete_fails_with_immutability_error</name>
        <description>Verify DELETE on ai_buddy_audit_logs raises "Audit logs are immutable" exception</description>
      </testIdea>
      <testIdea ac="AC-20.1.2">
        <name>test_service_role_cannot_modify</name>
        <description>Verify even service_role cannot UPDATE or DELETE audit logs (trigger blocks it)</description>
      </testIdea>
      <testIdea ac="AC-20.1.3">
        <name>test_schema_has_required_fields</name>
        <description>Verify table has all required columns with correct types via introspection query</description>
      </testIdea>
      <testIdea ac="AC-20.1.4">
        <name>test_query_performance_with_index</name>
        <description>Run EXPLAIN ANALYZE on agency_id + logged_at query, verify index is used</description>
      </testIdea>
      <testIdea ac="AC-20.1.1">
        <name>test_admin_can_select_with_permission</name>
        <description>Verify admin with view_audit_logs permission can SELECT audit logs for their agency</description>
      </testIdea>
      <testIdea ac="AC-20.1.1">
        <name>test_non_admin_cannot_select</name>
        <description>Verify user without view_audit_logs permission cannot SELECT audit logs</description>
      </testIdea>
    </ideas>
  </tests>
</story-context>
