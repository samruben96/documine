<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>12</epicId>
    <storyId>3</storyId>
    <title>Edge Function Integration</title>
    <status>drafted</status>
    <generatedAt>2025-12-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epics/epic-12/stories/12-3-edge-function-integration/12-3-edge-function-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>document processing system</asA>
    <iWant>the Edge Function to use Document AI for PDF parsing instead of Docling</iWant>
    <soThat>documents are processed reliably with enterprise-grade OCR in 5-30 seconds instead of 150+ seconds</soThat>
    <tasks>
      <task id="1" name="Import Response Conversion Function" status="ready">
        <subtask status="done">convertDocumentAIToDoclingResult() already implemented in Story 12.4</subtask>
        <subtask status="ready">Import function from documentai-client.ts in index.ts</subtask>
        <note>Story 12.4 completed - function available at documentai-client.ts:947</note>
      </task>
      <task id="2" name="Replace parseDocument() Function">
        <subtask>Import parseDocumentWithRetry from documentai-client.ts</subtask>
        <subtask>Update parseDocumentWithRetry() wrapper to call Document AI</subtask>
        <subtask>Convert response using convertDocumentAIToDoclingResult()</subtask>
        <subtask>Remove parseDocument() function (Docling-specific)</subtask>
        <subtask>Remove disableCellMatching parameter path</subtask>
      </task>
      <task id="3" name="Update Progress Reporting">
        <subtask>Verify progress updates at parsing stage are preserved</subtask>
        <subtask>Update logging to reference "Document AI" instead of "Docling"</subtask>
        <subtask>Keep elapsed time logging for performance metrics</subtask>
      </task>
      <task id="4" name="Integrate Error Classification">
        <subtask>Import classifyDocumentAIError from documentai-client.ts</subtask>
        <subtask>Map Document AI error codes to existing error categories</subtask>
        <subtask>Update error handling in main try/catch block</subtask>
        <subtask>Test error classification for common failure modes</subtask>
      </task>
      <task id="5" name="Remove Docling-Specific Code">
        <subtask>Remove PAGE_DIMENSIONS_ERROR_PATTERNS constant</subtask>
        <subtask>Remove isPageDimensionsError() function</subtask>
        <subtask>Remove getUserFriendlyError() function (or update for Document AI)</subtask>
        <subtask>Remove extractDiagnosticInfo() function</subtask>
        <subtask>Remove DOCLING_TIMEOUT_MS constant</subtask>
        <subtask>Make DOCLING_SERVICE_URL env var optional with deprecation warning</subtask>
        <subtask>Update module header comment</subtask>
      </task>
      <task id="6" name="Update Environment Variable Handling">
        <subtask>Remove doclingServiceUrl requirement from startup check</subtask>
        <subtask>Add warning log if DOCLING_SERVICE_URL is present (deprecated)</subtask>
        <subtask>Verify Document AI env vars are checked (from Story 12.1)</subtask>
      </task>
      <task id="7" name="Integration Test">
        <subtask>Manual test: Upload PDF and verify processing completes</subtask>
        <subtask>Verify progress updates show correctly in UI</subtask>
        <subtask>Verify error handling for invalid documents</subtask>
        <subtask>Verify chunking and embedding work with Document AI output</subtask>
        <subtask>Test with foran auto nationwide.pdf (the litmus test)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-12.3.1" name="parseDocument() Function Replaced with Document AI Call">
      <check>The parseDocument() function in index.ts is replaced to call Document AI</check>
      <check>Function calls parseDocumentWithRetry() from documentai-client.ts</check>
      <check>Function accepts same parameters: docBuffer, filename, serviceUrl</check>
      <check>serviceUrl parameter is now ignored (Document AI uses env vars)</check>
    </criterion>
    <criterion id="AC-12.3.2" name="parseDocumentWithRetry() Wrapper Updated">
      <check>Existing parseDocumentWithRetry() in index.ts delegates to Document AI version</check>
      <check>Maintains same return signature: DoclingResult { markdown, pageMarkers, pageCount }</check>
      <check>Converts Document AI response to DoclingResult format (via Story 12.4)</check>
      <check>Page-dimensions fallback logic removed (Document AI doesn't have this issue)</check>
    </criterion>
    <criterion id="AC-12.3.3" name="Progress Updates Continue at Parsing Stage">
      <check>Progress updates at parsing stage preserved: 0% at start, 100% at complete</check>
      <check>Stage name remains "parsing" for UI consistency</check>
      <check>updateJobProgress() calls unchanged</check>
    </criterion>
    <criterion id="AC-12.3.4" name="Error Classification Applied to Document AI Errors">
      <check>Document AI errors classified using classifyDocumentAIError() from Story 12.1</check>
      <check>Error codes mapped to existing classifyError() categories for consistency</check>
      <check>Transient errors (NETWORK_ERROR, TIMEOUT, QUOTA_EXCEEDED) trigger job retry</check>
      <check>Non-transient errors (AUTH_*, PROCESSOR_*, INVALID_DOCUMENT) marked as failed</check>
    </criterion>
    <criterion id="AC-12.3.5" name="Docling-Specific Code Paths Removed">
      <check>Docling service URL no longer required (env var check removed/optional)</check>
      <check>PAGE_DIMENSIONS_ERROR_PATTERNS constant removed (obsolete)</check>
      <check>isPageDimensionsError() function removed (obsolete)</check>
      <check>disable_cell_matching fallback logic removed (obsolete)</check>
      <check>Docling-specific timeout removed (uses Document AI 60s timeout from Story 12.2)</check>
      <check>getUserFriendlyError() updated for Document AI errors</check>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/epics/epic-12/tech-spec/tech-spec-epic-12.md" priority="high">
        Epic 12 Technical Specification - Document AI Migration
        - Current Architecture: Docling on Railway (150+ second hangs)
        - Target Architecture: Document AI (5-30 second processing)
        - Key Goal: Replace parseDocument() call with Document AI
        - Hard cutover - no Docling fallback
      </doc>
      <doc path="docs/sprint-artifacts/epics/epic-12/stories/12-1-connect-gcp-document-ai/12-1-connect-gcp-document-ai.md" priority="high">
        Story 12.1: Connect GCP Document AI (DONE)
        - JWT authentication implemented via Web Crypto API
        - getAccessToken(), getDocumentAIConfig(), getServiceAccountKey() available
        - classifyDocumentAIError() ready for error classification
        - Token caching with 1-hour TTL
      </doc>
      <doc path="docs/sprint-artifacts/epics/epic-12/stories/12-2-document-ai-parsing-service/12-2-document-ai-parsing-service.md" priority="high">
        Story 12.2: Document AI Parsing Service (DONE)
        - parseDocumentWithRetry() available in documentai-client.ts
        - DocumentAIProcessResponse type ready
        - 60-second timeout with AbortController
        - Exponential backoff retry (1s, 2s)
      </doc>
      <doc path="docs/architecture/rag-pipeline-architecture-implemented.md" priority="medium">
        RAG Pipeline Architecture - Shows chunking/embedding flow that must work with Document AI output
      </doc>
    </docs>
    <code>
      <file path="supabase/functions/process-document/index.ts" priority="critical" lines="2200">
        MAIN FILE TO MODIFY - Edge Function orchestrating document processing

        Key sections to update:
        - Line 37-38: Remove DOCLING_TIMEOUT_MS constant
        - Line 42-58: Remove PAGE_DIMENSIONS_ERROR_PATTERNS, USER_FRIENDLY_ERRORS
        - Line 252-259: Update env var check (remove doclingServiceUrl requirement)
        - Line 376-406: Replace parseDocumentWithRetry() call (currently calls Docling)
        - Line 640-706: Replace parseDocumentWithRetry() function (Docling-specific)
        - Line 713-783: Remove parseDocument() function (Docling-specific)
        - Line 2052-2094: Remove isPageDimensionsError(), getUserFriendlyError(), extractDiagnosticInfo()

        Keep unchanged:
        - STAGE_WEIGHTS (line 139-145) - already includes all stages
        - STAGE_DISPLAY_NAMES (line 192-198) - user-facing names stay same
        - updateJobProgress() calls (line 352-398) - progress reporting continues
        - chunkMarkdown() (line 950-976) - chunking logic unchanged
        - generateEmbeddingsWithRetry() (line 1124-1147) - embedding logic unchanged
        - performQuoteExtraction() (line 1849-2033) - extraction logic unchanged

        DoclingResult interface (line 616-620):
        ```typescript
        interface DoclingResult {
          markdown: string;
          pageMarkers: PageMarker[];
          pageCount: number;
        }
        ```
        This interface is preserved - Document AI response must be converted to this format.
      </file>
      <file path="supabase/functions/process-document/documentai-client.ts" priority="high" lines="1113">
        Document AI client module (from Stories 12.1, 12.2, 12.4) - READ ONLY, do not modify

        Functions to import and use:
        - parseDocumentWithRetry(pdfBuffer: Uint8Array): Promise&lt;DocumentAIProcessResponse&gt; (line 726)
        - convertDocumentAIToDoclingResult(response: DocumentAIProcessResponse): DoclingResult (line 947)
        - classifyDocumentAIError(error: Error | string): DocumentAIConnectionError (line 425)
        - isTransientError(code: DocumentAIErrorCode): boolean (line 601)

        Key types:
        - DocumentAIProcessResponse (line 126-131): { document: { text: string; pages: DocumentAIPage[] } }
        - DocumentAIPage (line 114-120): { pageNumber, dimension, layout, paragraphs, tables }
        - DocumentAIErrorCode (line 139-150): Error codes for classification
        - DocumentAIConnectionError (line 152-157): Structured error with userMessage
        - DoclingResult (defined in file): { markdown, pageMarkers, pageCount }
        - PageMarker (defined in file): { pageNumber, startIndex, endIndex }

        Already includes:
        - 60-second timeout with AbortController (line 620, 657-668)
        - Retry with exponential backoff (line 730-773)
        - Token caching (line 162, 285-345)
        - Response conversion with page markers and table formatting (line 947-1113)
      </file>
    </code>
    <dependencies>
      <dependency name="Story 12.1 - Connect GCP Document AI" status="done">
        Provides: getAccessToken(), getDocumentAIConfig(), classifyDocumentAIError()
      </dependency>
      <dependency name="Story 12.2 - Document AI Parsing Service" status="done">
        Provides: parseDocumentWithRetry(), DocumentAIProcessResponse type
      </dependency>
      <dependency name="Story 12.4 - Response Parsing" status="done">
        Provides: convertDocumentAIToDoclingResult() function (documentai-client.ts:947-1113)
        - Converts DocumentAIProcessResponse to DoclingResult format
        - Handles page markers, tables, whitespace normalization
        - 20 unit tests passing
        Ready for import and use in Story 12.3
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">
      Preserve DoclingResult interface signature - downstream code depends on { markdown, pageMarkers, pageCount }
    </constraint>
    <constraint type="operational">
      Stage name must remain "parsing" for UI consistency with existing progress display
    </constraint>
    <constraint type="operational">
      Hard cutover - no Docling fallback. If Document AI fails, document processing fails.
    </constraint>
    <constraint type="performance">
      Document AI timeout is 60 seconds (set in documentai-client.ts). Do not add additional timeouts.
    </constraint>
    <constraint type="security">
      DOCLING_SERVICE_URL will be deprecated but should not cause failure if still present in env vars
    </constraint>
  </constraints>

  <interfaces>
    <interface name="parseDocumentWithRetry (current Docling version - TO BE REPLACED)">
      Location: supabase/functions/process-document/index.ts:640-706
      Signature: (docBuffer: Uint8Array, filename: string, serviceUrl: string) => Promise&lt;DoclingResult&gt;

      The NEW version should:
      - Import parseDocumentWithRetry from documentai-client.ts
      - Ignore serviceUrl parameter (kept for backward compat)
      - Call Document AI parseDocumentWithRetry(docBuffer)
      - Convert DocumentAIProcessResponse to DoclingResult format
      - Return same DoclingResult shape
    </interface>
    <interface name="DoclingResult">
      Location: supabase/functions/process-document/index.ts:616-620
      ```typescript
      interface DoclingResult {
        markdown: string;       // Full document text with page markers
        pageMarkers: PageMarker[];  // Array of { pageNumber, startIndex, endIndex }
        pageCount: number;      // Total pages
      }
      ```
    </interface>
    <interface name="DocumentAIProcessResponse">
      Location: supabase/functions/process-document/documentai-client.ts:126-131
      ```typescript
      interface DocumentAIProcessResponse {
        document: {
          text: string;
          pages: DocumentAIPage[];
        };
      }
      ```
    </interface>
    <interface name="classifyError (existing)">
      Location: supabase/functions/process-document/index.ts:116-133
      Returns: ClassifiedError { errorType, category, code, shouldAutoRetry }

      Document AI errors from classifyDocumentAIError() need to be mapped to these existing categories
      so that the job status update logic works correctly.
    </interface>
  </interfaces>

  <tests>
    <standards>
      - All 1514 existing tests must continue passing
      - Build must succeed without errors
      - E2E test: document upload to 'ready' status
      - Manual test with foran auto nationwide.pdf (litmus test)
    </standards>
    <locations>
      - __tests__/supabase/documentai-parsing.test.ts - Existing Document AI tests from Story 12.2
      - Manual testing via Supabase Dashboard > Edge Function logs
      - E2E tests in __tests__/e2e/ directory
    </locations>
    <ideas>
      <testCase priority="high" id="TC-12.3.1">
        Upload PDF and verify processing completes with Document AI (not Docling)
        Check Edge Function logs for "Document AI parsing completed" message
      </testCase>
      <testCase priority="high" id="TC-12.3.2">
        Verify progress updates at parsing stage (0%, 100%)
        Use Realtime subscription or processing_jobs table query
      </testCase>
      <testCase priority="high" id="TC-12.3.3">
        Test with foran auto nationwide.pdf - must complete in &lt;60 seconds
        This document hangs with Docling, should succeed with Document AI
      </testCase>
      <testCase priority="medium" id="TC-12.3.4">
        Verify error handling for invalid document
        Upload corrupted PDF, verify error is classified correctly
      </testCase>
      <testCase priority="medium" id="TC-12.3.5">
        Verify DOCLING_SERVICE_URL deprecation warning
        If env var present, log warning but don't fail
      </testCase>
      <testCase priority="low" id="TC-12.3.6">
        Verify chunking and embedding work correctly with Document AI output
        Check document_chunks table has expected data
      </testCase>
    </ideas>
  </tests>
</story-context>
