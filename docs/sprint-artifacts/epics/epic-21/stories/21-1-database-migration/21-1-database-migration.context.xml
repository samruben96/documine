<story-context id="21-1-database-migration" v="1.0">
  <metadata>
    <epicId>21</epicId>
    <storyId>1</storyId>
    <title>Database Migration - Agency Admin Tables</title>
    <status>drafted</status>
    <generatedAt>2025-12-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epics/epic-21/stories/21-1-database-migration/story.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>platform architect</asA>
    <iWant>admin-related tables renamed from `ai_buddy_*` to `agency_*`</iWant>
    <soThat>the database schema accurately reflects that admin functionality is agency-wide, not feature-specific</soThat>
    <tasks>
      <task id="1">Create migration file `20251210000000_agency_admin_consolidation.sql`</task>
      <task id="2">Rename `ai_buddy_permission` enum to `agency_permission`</task>
      <task id="3">Rename `ai_buddy_permissions` table to `agency_permissions`</task>
      <task id="4">Rename `ai_buddy_audit_logs` table to `agency_audit_logs`</task>
      <task id="5">Merge `ai_buddy_invitations` into `invitations` table</task>
      <task id="6">Drop `ai_buddy_invitations` table</task>
      <task id="7">Update all RLS policies to reference new table names</task>
      <task id="8">Create reverse migration script</task>
      <task id="9">Test migration locally with Supabase CLI</task>
      <task id="10">Regenerate TypeScript types</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-21.1.1" title="Permissions Table Renamed">
      Given the database has `ai_buddy_permissions` table
      When the migration runs
      Then the table is renamed to `agency_permissions`
      And all foreign key constraints are preserved
      And existing data is intact
    </criterion>
    <criterion id="AC-21.1.2" title="Audit Logs Table Renamed">
      Given the database has `ai_buddy_audit_logs` table
      When the migration runs
      Then the table is renamed to `agency_audit_logs`
      And all foreign key constraints are preserved
      And existing data is intact
    </criterion>
    <criterion id="AC-21.1.3" title="Permission Enum Renamed">
      Given the database has `ai_buddy_permission` enum type
      When the migration runs
      Then the enum is renamed to `agency_permission`
      And all columns using this enum continue to work
    </criterion>
    <criterion id="AC-21.1.4" title="Invitations Merged">
      Given pending invitations exist in `ai_buddy_invitations`
      When the migration runs
      Then they are merged into the main `invitations` table
      And `ai_buddy_invitations` table is dropped
      And no duplicate invitations are created
    </criterion>
    <criterion id="AC-21.1.5" title="RLS Policies Updated">
      Given RLS policies reference `ai_buddy_permissions`
      When the migration runs
      Then all policies reference `agency_permissions` instead
      And permission checks continue to work correctly
    </criterion>
    <criterion id="AC-21.1.6" title="Migration is Reversible">
      Given the migration has been applied
      When a rollback is needed
      Then the migration can be reversed without data loss
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/epics/epic-21/tech-spec/index.md</path>
        <title>Epic 21 Technical Specification</title>
        <section>Database Migration Details</section>
        <snippet>Phase 1 covers renaming ai_buddy_permissions to agency_permissions, ai_buddy_audit_logs to agency_audit_logs, merging invitations, and updating RLS policies.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/data-architecture.md</path>
        <title>Data Architecture</title>
        <section>Database Schema</section>
        <snippet>Multi-tenant architecture with agency_id isolation. RLS policies enforce data boundaries at the database level.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/security-architecture.md</path>
        <title>Security Architecture</title>
        <section>Row Level Security</section>
        <snippet>All tables use RLS with agency-based filtering. Audit logs are append-only with no UPDATE/DELETE policies.</snippet>
      </doc>
      <doc>
        <path>docs/prd/saas-b2b-specific-requirements.md</path>
        <title>SaaS B2B Requirements</title>
        <section>Multi-Tenancy</section>
        <snippet>Agency isolation via agency_id column on all user-generated data. Permissions system controls feature access.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql</path>
        <kind>migration</kind>
        <symbol>ai_buddy_permissions, ai_buddy_audit_logs, ai_buddy_permission enum</symbol>
        <lines>1-386</lines>
        <reason>Original table definitions being renamed. Contains current schema, indexes, RLS policies to recreate.</reason>
      </file>
      <file>
        <path>supabase/migrations/20251210000000_admin_user_management.sql</path>
        <kind>migration</kind>
        <symbol>ai_buddy_invitations</symbol>
        <lines>1-157</lines>
        <reason>Defines ai_buddy_invitations table that needs to be merged into main invitations table.</reason>
      </file>
      <file>
        <path>supabase/migrations/00005_create_invitations.sql</path>
        <kind>migration</kind>
        <symbol>invitations</symbol>
        <lines>1-57</lines>
        <reason>Target invitations table for merge. Has status column, different schema to reconcile.</reason>
      </file>
      <file>
        <path>supabase/migrations/20251211000000_transfer_ownership_function.sql</path>
        <kind>migration</kind>
        <symbol>transfer_ownership function</symbol>
        <lines>1-123</lines>
        <reason>Uses ai_buddy_permissions table. Function must be updated after table rename.</reason>
      </file>
      <file>
        <path>src/lib/auth/admin.ts</path>
        <kind>service</kind>
        <symbol>requireAdminAuth</symbol>
        <lines>61-137</lines>
        <reason>Queries ai_buddy_permissions table. Must be updated to use agency_permissions after Story 21.2.</reason>
      </file>
      <file>
        <path>src/lib/ai-buddy/audit-logger.ts</path>
        <kind>service</kind>
        <symbol>logAuditEvent, queryAuditLogs</symbol>
        <lines>1-266</lines>
        <reason>Uses ai_buddy_audit_logs table. Must be updated to agency_audit_logs after Story 21.2.</reason>
      </file>
      <file>
        <path>src/types/database.types.ts</path>
        <kind>types</kind>
        <symbol>ai_buddy_permissions, ai_buddy_audit_logs, ai_buddy_invitations types</symbol>
        <lines>351-389, 65-116, 246-296</lines>
        <reason>Generated types will need regeneration after migration. Documents current schema.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.84.0</version>
        <purpose>Database client, used for all queries</purpose>
      </node>
      <node>
        <package>next</package>
        <version>^16.0.7</version>
        <purpose>Framework</purpose>
      </node>
      <node>
        <package>typescript</package>
        <version>^5</version>
        <purpose>Type generation target</purpose>
      </node>
      <devDependency>
        <package>vitest</package>
        <version>^4.0.14</version>
        <purpose>Unit testing</purpose>
      </devDependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use PostgreSQL ALTER TABLE ... RENAME TO for table renames - preserves FK constraints automatically</constraint>
    <constraint type="pattern">Use ALTER TYPE ... RENAME TO for enum rename - cannot modify enum values in same transaction</constraint>
    <constraint type="data">Ensure migration is idempotent - use IF EXISTS checks where appropriate</constraint>
    <constraint type="data">No data loss - all existing permissions, audit logs, and invitations must be preserved</constraint>
    <constraint type="rls">Audit logs must remain append-only - no UPDATE/DELETE policies even after rename</constraint>
    <constraint type="rls">RLS policies must reference new table names after rename</constraint>
    <constraint type="rollback">Include reverse migration script for AC-21.1.6 compliance</constraint>
    <constraint type="compatibility">transfer_ownership function references ai_buddy_permissions - must update function or create alias</constraint>
    <constraint type="invitation-merge">ai_buddy_invitations has cancelled_at column, invitations has status column - reconcile schemas</constraint>
    <constraint type="invitation-merge">Use ON CONFLICT for deduplication when merging invitations</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ai_buddy_permission enum</name>
      <kind>database enum</kind>
      <signature>enum: use_ai_buddy | manage_own_projects | manage_users | configure_guardrails | view_audit_logs | view_usage_analytics | manage_billing | transfer_ownership | delete_agency</signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql:12-18</path>
    </interface>
    <interface>
      <name>ai_buddy_permissions table</name>
      <kind>database table</kind>
      <signature>id UUID, user_id UUID FK, permission ai_buddy_permission, granted_by UUID, granted_at TIMESTAMPTZ</signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql:138-145</path>
    </interface>
    <interface>
      <name>ai_buddy_audit_logs table</name>
      <kind>database table</kind>
      <signature>id UUID, agency_id UUID FK, user_id UUID FK, conversation_id UUID, action VARCHAR(50), metadata JSONB, logged_at TIMESTAMPTZ</signature>
      <path>supabase/migrations/20251207000000_ai_buddy_foundation.sql:155-163</path>
    </interface>
    <interface>
      <name>ai_buddy_invitations table</name>
      <kind>database table</kind>
      <signature>id UUID, agency_id UUID FK, email TEXT, role TEXT, invited_by UUID FK, invited_at TIMESTAMPTZ, expires_at TIMESTAMPTZ, accepted_at TIMESTAMPTZ, cancelled_at TIMESTAMPTZ</signature>
      <path>supabase/migrations/20251210000000_admin_user_management.sql:28-39</path>
    </interface>
    <interface>
      <name>invitations table (target)</name>
      <kind>database table</kind>
      <signature>id UUID, agency_id UUID FK, email TEXT, role TEXT, status TEXT, invited_by UUID FK, expires_at TIMESTAMPTZ, created_at TIMESTAMPTZ, accepted_at TIMESTAMPTZ</signature>
      <path>supabase/migrations/00005_create_invitations.sql:8-18</path>
    </interface>
    <interface>
      <name>transfer_ownership function</name>
      <kind>database function</kind>
      <signature>transfer_ownership(p_current_owner_id UUID, p_new_owner_id UUID, p_agency_id UUID) RETURNS JSONB</signature>
      <path>supabase/migrations/20251211000000_transfer_ownership_function.sql:12-103</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with happy-dom. Database migrations are tested manually via Supabase CLI (`npx supabase db push`).
      Integration tests verify RLS policies work correctly after schema changes.
      TypeScript types regenerated via `npm run generate-types` and must compile without errors.
    </standards>
    <locations>
      <location>__tests__/hooks/admin/</location>
      <location>__tests__/components/admin/</location>
      <location>__tests__/e2e/admin/</location>
      <location>Manual testing: Local Supabase with `npx supabase db push`</location>
    </locations>
    <ideas>
      <idea acRef="AC-21.1.1">Verify agency_permissions table exists after migration, test permission lookup queries work</idea>
      <idea acRef="AC-21.1.2">Verify agency_audit_logs table exists, test audit log insertion and querying</idea>
      <idea acRef="AC-21.1.3">Verify agency_permission enum is used by permission column in agency_permissions</idea>
      <idea acRef="AC-21.1.4">Insert test invitation in ai_buddy_invitations before migration, verify it exists in invitations after</idea>
      <idea acRef="AC-21.1.5">Test RLS: admin can view agency_permissions, non-admin cannot</idea>
      <idea acRef="AC-21.1.6">Apply migration, run rollback script, verify original tables restored</idea>
      <idea>Run `npm run generate-types` and verify build passes with new types</idea>
      <idea>Test transfer_ownership function works after migration</idea>
    </ideas>
  </tests>
</story-context>
